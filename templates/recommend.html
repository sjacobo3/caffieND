{% extends "base.html" %}

{% block title %}Recommendations{% endblock %}

{% block content %}

<!-- start with recommendation quiz / prompts -->
<div class="{% if recommendation is not none %}d-none{% endif %}">
    <form action="/recommendation" method="POST" class="p-4">
        <div style="text-align: center;">
            <h1 class="title">Find Your Perfect Drink!</h1>
        </div>
        <!-- prompt user for mood -->
        <div class="quiz-step">
            <label style="font-size:1.5rem;"><strong>Mood:</strong></label>
            <div class="d-flex flex-column gap-2 mt-2">
                <button type="button" class="choice-btn btn btn-outline-primary" data-value="night">Late Night
                    Focus</button>
                <button type="button" class="choice-btn btn btn-outline-primary" data-value="morning">Morning
                    Vibes</button>
                <button type="button" class="choice-btn btn btn-outline-primary" data-value="gym">Gym Session</button>
                <button type="button" class="choice-btn btn btn-outline-primary" data-value="refresh">Refresh</button>
            </div>
            <input type="hidden" name="mood" required>
            <button type="button" class="next-btn btn btn-primary mt-2" disabled>Next</button>
        </div>

        <!-- prompt user for flavor preference -->
        <div class="quiz-step d-none">
            <label style="font-size:1.5rem;"><strong>Flavor Preference:</strong></label>
            <div class="d-flex flex-column gap-2 mt-2" id="flavor-options">
                <!-- generate flavors based on mood -->
                <button type="button" class="choice-btn btn btn-outline-primary" data-value="no-pref">No
                    Preference</button>
            </div>
            <input type="hidden" name="flavor" required>
            <button type="button" class="prev-btn btn btn-secondary mt-2">Back</button>
            <button type="button" class="next-btn btn btn-primary mt-2" disabled>Next</button>
        </div>

        <!-- prompt user for calorie and sugar preference -->
        <div class="quiz-step d-none">
            <label style="font-size:1.5rem;"><strong>Calorie Preference:</strong></label>
            <div class="d-flex flex-column gap-2 mt-2">
                <button type="button" class="choice-btn btn btn-outline-primary" data-value="low-cal">Low</button>
                <button type="button" class="choice-btn btn btn-outline-primary" data-value="med-cal">Medium</button>
                <button type="button" class="choice-btn btn btn-outline-primary" data-value="high-cal">High</button>
                <button type="button" class="choice-btn btn btn-outline-primary" data-value="no-pref">No
                    Preference</button>
            </div>
            <input type="hidden" name="calorie_pref" required>
            <button type="button" class="prev-btn btn btn-secondary mt-2">Back</button>
            <button type="button" class="next-btn btn btn-primary mt-2" disabled>Next</button>

        </div>

        <div class="quiz-step d-none">
            <label style="font-size:1.5rem;"><strong>Sugar Preference:</strong></label>
            <div class="d-flex flex-column gap-2 mt-2">
                <button type="button" class="choice-btn btn btn-outline-primary" data-value="low-sugar">Low</button>
                <button type="button" class="choice-btn btn btn-outline-primary" data-value="med-sugar">Medium</button>
                <button type="button" class="choice-btn btn btn-outline-primary" data-value="high-sugar">High</button>
                <button type="button" class="choice-btn btn btn-outline-primary" data-value="no-pref">No
                    Preference</button>
            </div>
            <input type="hidden" name="sugar_pref" required>
            <button type="button" class="prev-btn btn btn-secondary mt-2">Back</button>
            <button type="button" class="next-btn btn btn-primary mt-2" disabled>Next</button>
        </div>

        <!-- prompt user for similarity -->
        <div class="quiz-step d-none">
            <label style="font-size:1.5rem;"><strong>Familiar or New:</strong></label>
            <div class="d-flex flex-column gap-2 mt-2">
                <button type="button" class="choice-btn btn btn-outline-primary" data-value="new">Something New</button>
                <button type="button" class="choice-btn btn btn-outline-primary" data-value="favorites">Similar to My
                    Favorites</button>
            </div>
            <input type="hidden" name="similarity" required>
            <button type="button" class="prev-btn btn btn-secondary mt-2">Back</button>
            <button type="submit" class="btn btn-success mt-2" disabled>Generate Drinks</button>
        </div>
    </form>
</div>

<!-- generate drinks and allow user to favorite / log -->
<div id="generated-drinks"
    class="d-flex flex-column {% if recommendation is none %}d-none{% endif %} align-items-center ">
    {% if recommendation is not none %}
    <h2 class="title mb-4">Your Recommended Drinks</h2>
    {% if recommendation|length > 0 %}
    <div class="row justify-content-center">
        {% for drink in recommendation %}
        <div class="col-12 col-sm-6 col-md-3 mb-4">
            <div class="card shadow-sm border-0 h-100" style="cursor:pointer;" data-bs-toggle="modal"
                data-bs-target="#drinkModal-{{ drink.drink_id }}">
                <div class="card-body d-flex flex-column justify-content-between">
                    <h5 class="card-title">{{ drink.name }}</h5>
                    <small class="text-muted">{{ drink.calories }} cal</small>

                    <p class="mb-1">
                        {% if drink.flavor %} <strong>Flavor:</strong> {{ drink.flavor }} <br /> {% endif %}
                        <strong>Caffeine:</strong> {{ drink.caffeine_amt }} mg <br />
                        <strong>Sugar:</strong> {{ drink.sugar_g }} g
                    </p>
                </div>
            </div>

            <!-- modal for each drink -->
            <div class="modal fade" id="drinkModal-{{ drink.drink_id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">

                        <!-- modal header -->
                        <div class="modal-header">
                            <h5 class="modal-title">{{ drink.name }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>

                        <!-- modal body -->
                        <div class="modal-body">

                            <!-- favorites -->
                            {% if drink.drink_id in user_favorites %}
                            <form action="{{ url_for('remove_favorite') }}" method="POST" class="mb-3">
                                <input type="hidden" name="drink_id" value="{{ drink.drink_id }}">
                                <!-- remove from favorites -->
                                <button class="btn btn-secondary w-100" type="submit">☆ Remove from
                                    Favorites</button>
                            </form>
                            {% else %}
                            <form action="{{ url_for('add_favorite') }}" method="POST" class="mb-3">
                                <input type="hidden" name="drink_id" value="{{ drink.drink_id }}">
                                <!-- add to favorites -->
                                <button class="btn btn-warning w-100" type="submit">★ Add to Favorites</button>
                            </form>
                            {% endif %}

                            <hr>

                            <!-- log drink form -->
                            <form action="{{ url_for('log_drink') }}" method="POST">
                                <input type="hidden" name="drink_id" value="{{ drink.drink_id }}">

                                <div class="mb-3">
                                    <label for="drink_ml-{{ drink.drink_id }}" class="form-label">Amount
                                        consumed
                                        (mL)</label>
                                    <input type="number" class="form-control" id="drink_ml-{{ drink.drink_id }}"
                                        name="drink_ml" required min="1">
                                </div>

                                <div class="d-grid">
                                    {% if drink.exceeds_daily_max %}
                                        <span class="warning">Exceeds your daily caffeine limit</span>
                                    {% endif %}
                                    <button type="submit" class="btn btn-success">✓ Log This Drink</button>
                                </div>
                            </form>

                        </div>

                        <!-- modal footer -->
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>

                    </div>
                </div>
            </div>
            <!-- end modal -->
        </div>

        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-warning" role="alert">
        No drinks matched all your preferences.

    </div>
    {% endif %}
    <a href="/recommendation" class="btn btn-info mt-3">Start a New Quiz</a>
    {% endif %}
</div>

<script>
    const flavor_options = {
        "night": ["Fruity", "Citrus", "Herbal"],
        "morning": ["Vanilla", "Caramel", "Hazelnut", "Mocha"],
        "gym": ["Berry", "Citrus", "Watermelon"],
        "refresh": ["Mint", "Peach", "Citrus", "Lime"]
    };

    document.addEventListener("DOMContentLoaded", function () {
        const steps = document.querySelectorAll(".quiz-step");
        const form = document.querySelector("form");
        const drinksSection = document.getElementById("generated-drinks");
        let currentStep = 0;

        const showStep = index => {
            steps.forEach((s, i) => {
                s.classList.toggle("d-none", i !== index);
            });

            const currentStepElement = steps[index];
            const hiddenInput = currentStepElement.querySelector("input[type='hidden']");
            const nextBtn = currentStepElement.querySelector(".next-btn") || currentStepElement.querySelector("button[type='submit']");

            if (nextBtn) {
                nextBtn.disabled = !hiddenInput.value;
            }
        };

        const handleChoiceSelection = (event) => {
            const btn = event.currentTarget;
            const step = btn.closest(".quiz-step");
            const hiddenInput = step.querySelector("input[type='hidden']");
            const nextBtn = step.querySelector(".next-btn") || step.querySelector("button[type='submit']");

            hiddenInput.value = btn.dataset.value;

            step.querySelectorAll(".choice-btn").forEach(b => {
                b.classList.remove("btn-primary");
                b.classList.add("btn-outline-primary");
            });
            btn.classList.remove("btn-outline-primary");
            btn.classList.add("btn-primary");

            if (nextBtn) {
                nextBtn.disabled = false;
            }

            if (hiddenInput.name === "mood") {
                steps[1].querySelector("input[name='flavor']").value = "";
                steps[1].querySelectorAll(".choice-btn").forEach(b => {
                    b.classList.remove("btn-primary");
                    b.classList.add("btn-outline-primary");
                });
                generateFlavorOptions(hiddenInput.value);
            }
        };

        const nextBtns = document.querySelectorAll(".next-btn");
        nextBtns.forEach(btn => {
            btn.addEventListener("click", () => {
                currentStep++;
                if (currentStep < steps.length) {
                    showStep(currentStep);
                }
            });
        });

        const prevBtns = document.querySelectorAll(".prev-btn");
        prevBtns.forEach(btn => {
            btn.addEventListener("click", () => {
                currentStep--;
                if (currentStep < 0) currentStep = 0;
                showStep(currentStep);
            });
        });

        const choiceBtns = document.querySelectorAll(".choice-btn");
        choiceBtns.forEach(btn => {
            btn.addEventListener("click", handleChoiceSelection);
        });

        showStep(currentStep);

        // Function to generate flavor options
        const generateFlavorOptions = (mood) => {
            const flavorContainer = document.getElementById("flavor-options");
            const noPrefButton = flavorContainer.querySelector('[data-value="no-pref"]');
            flavorContainer.innerHTML = '';

            if (flavor_options[mood]) {
                flavor_options[mood].forEach(flavorName => {
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = "choice-btn btn btn-outline-primary";
                    btn.dataset.value = flavorName.toLowerCase();
                    btn.textContent = flavorName;
                    btn.addEventListener("click", handleChoiceSelection);
                    flavorContainer.appendChild(btn);
                });
            }

            flavorContainer.appendChild(noPrefButton);
        };
    });

</script>
{% endblock %}