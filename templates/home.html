{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block content %}

<div class="text-center mb-4">
    <h1 class="title">CaffieND!</h1>
</div>

<form action="/" method="GET" class="mb-4">
    <div class="row">
        <!-- filters -->
        <div class="col-md-3">
            <h5>Filters:</h5>

	    <!-- calories -->
	    <div class="row g-3 mb-3"> 
		    <h6>Calories:</h6>
	            <div class="col mt-0">
                    <input type="text" class="form-control" name="calorie_min" placeholder="min" value="{{ request.args.get('calorie_min','') }}" />
	            </div>
                <div class="col mt-0">
                    <input type="text" class="form-control" name="calorie_max" placeholder="max" value="{{ request.args.get('calorie_max','') }}" />
                </div>
	    </div>

            <!-- caffeine --> 
	    <div class="row g-3"> 
		    <h6>Caffeine:</h6>
	            <div class="col mt-0">
			        <input type="text" class="form-control" name="caffeine_min" placeholder="min" value="{{ request.args.get('caffeine_min','') }}" />
	            </div>
		    <div class="col mt-0">
			    <input type="text" class="form-control" name="caffeine_max" placeholder="max" value="{{ request.args.get('caffeine_max','') }}" />
	        </div>
        </div>

	    <!-- drink type -->
         <div class="row g-3">
            <h6>Category:</h6>
            {% for type in drink_types %}
                <div class="form-check"> 
					<input class="form-check-input" type="checkbox" name="drink_type" value="{{ type }}" id="drink_type_{{ loop.index }}" {% if type in request.args.getlist('drink_type') %}checked{% endif %}/>
                        <label class="form-check-label" for="drink_type_{{ loop.index }}">{{ type }}</label>
                </div>
            {% endfor %}
         </div>
        <button class="btn btn-secondary w-100 mt-3 mb-5" type="submit">Apply
            Filters
        </button>
    </div>

        <!-- main content -->
        <div class="col-md-9">
            <!-- search bar -->
            <div class="input-group mb-3">
                <input type="text" class="form-control" name="drink_name" placeholder="Search for a drink..."
                    value="{{ request.args.get('drink_name', '') }}">
                <button class="btn btn-primary" type="submit">Search</button>
            </div>

            <!-- Drink Cards -->
            <div class="row justify-content-center">
                {% for drink in drinks %}
                <div class="col-12 col-sm-6 col-md-3 mb-4">
                    <div class="card shadow-sm border-0 h-100" style="cursor:pointer;" data-bs-toggle="modal"
                        data-bs-target="#drinkModal-{{ drink.drink_id }}">
                        <div class="card-body">
                            <h5 class="card-title">{{ drink.name }}</h5>
                            <p class="card-text mb-1"><strong>Volume:</strong> {{ drink.volume }}</p>
                            <p class="card-text mb-1"><strong>Calories:</strong> {{ drink.calories }}</p>
                            <p class="card-text mb-1"><strong>Amount:</strong> {{ drink.caffeine_amt }}</p>
                            <!-- <p class="card-text mb-1"><strong>Type:</strong> {{ drink.caffeine_type }}</p> -->
                        </div>
                    </div>

                    <!-- Modal for each drink -->
                    <div class="modal fade" id="drinkModal-{{ drink.drink_id }}" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">

                                <!-- Modal Header -->
                                <div class="modal-header">
                                    <h5 class="modal-title">{{ drink.name }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>

                                <!-- Modal Body -->
                                <div class="modal-body">

                                    <!-- Favorites -->
                                    {% if drink.drink_id in user_favorites %}
                                    <form action="{{ url_for('remove_favorite') }}" method="POST" class="mb-3">
                                        <input type="hidden" name="drink_id" value="{{ drink.drink_id }}">
                                        <!-- remove from favorites -->
                                        <button class="btn btn-secondary w-100" type="submit">☆ Remove from
                                            Favorites</button>
                                    </form>
                                    {% else %}
                                    <form action="{{ url_for('add_favorite') }}" method="POST" class="mb-3">
                                        <input type="hidden" name="drink_id" value="{{ drink.drink_id }}">
                                        <!-- add to favorites -->
                                        <button class="btn btn-warning w-100" type="submit">★ Add to
                                            Favorites</button>
                                    </form>
                                    {% endif %}

                                    <hr>

									<!--Drink Rating-->
                                    
                                    <form action="{{ url_for('rate_drink') }}" method="POST" class="mb-3">
                                        <input type="hidden" name="drink_id" value="{{ drink.drink_id }}">

                                        <div class="mb-3">
                                            {% if drink.drink_id in user_ratings %}
                                            <p class="text-success mb-2">
                                                Your rating: {{ user_ratings[drink.drink_id] }}
                                            </p>
                                            {% endif %}
                                            <label for="Rating--{{ drink.drink_id }}" class="form-label">Rate the drink on a scale from 1-5. One decimal place allowed</label>
                                            <input type="number" step="0.1" max="5" class="form-control" id="Rating--{{ drink.drink_id }}"
                                                name="rate_id" min="1">
                                        </div>
                                        <button class="btn btn-primary w-100" type="submit">Rate or Update Rating</button>
                                    </form>

                                    <hr>

                                    <!-- Log Drink Form -->
                                    <form action="{{ url_for('log_drink') }}" method="POST">
                                        <input type="hidden" name="drink_id" value="{{ drink.drink_id }}">

                                        <div class="mb-3">
                                            <label for="drink_ml-{{ drink.drink_id }}" class="form-label">Amount
                                                consumed
                                                (mL)</label>
                                            <input type="number" class="form-control" id="drink_ml-{{ drink.drink_id }}"
                                                name="drink_ml" required min="1">
                                        </div>

                                        <div class="mb-3">
                                            <label for="drink_hour-{{ drink.drink_id }}" class="form-label">Time of Consumption</label>
                                            <select class="form-select" id="drink_hour-{{ drink.drink_id }}"name="drink_hour" required>
                                                <option value="" disabled selected>Select hour</option>
                                                {% for hour in range(0, 24) %}
                                                    {% set display_hour = hour % 12 %}
                                                    {% if display_hour == 0 %}
                                                        {% set display_hour = 12 %}
                                                    {% endif %}
                                                    {% set ampm = 'AM' if hour < 12 else 'PM' %}
                                                    <option value="{{ hour }}">{{ display_hour }}:00 {{ ampm }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-success">✓ Log This Drink</button>
                                        </div>
                                    </form>

                                </div>

                                <!-- Modal Footer -->
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Close</button>
                                </div>

                            </div>
                        </div>
                    </div>
                    <!-- End Modal -->

                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</form>

<!-- Pagination -->
<nav>
    <ul class="pagination justify-content-center mt-4">

        {% if pagination.has_prev %}
        <li class="page-item">
            <a class="page-link"
                href="{{ url_for('home',
                                    page=pagination.prev_num,
                                    drink_name=request.args.get('drink_name',''),
                                    calorie_min=request.args.get('calorie_min',''),
                                    calorie_max=request.args.get('calorie_max',''),
                                    caffeine_min=request.args.get('caffeine_min',''),
                                    caffeine_max=request.args.get('caffeine_max','')) }}">
                Previous
            </a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}

        {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
        {% if p %}
        {% if p == pagination.page %}
        <li class="page-item active"><span class="page-link">{{ p }}</span></li>
        {% else %}
        <li class="page-item">
            <a class="page-link"
                href="{{ url_for('home',
                        page=p,
                        drink_name=request.args.get('drink_name',''),
                        calorie_min=request.args.get('calorie_min',''),
                        calorie_max=request.args.get('calorie_max',''),
                        caffeine_min=request.args.get('caffeine_min',''),
                        caffeine_max=request.args.get('caffeine_max','')) }}">
                {{ p }}
            </a>
        </li>
        {% endif %}
        {% else %}
        <li class="page-item disabled"><span class="page-link">…</span></li>
        {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
        <li class="page-item">
            <a class="page-link"
                href="{{ url_for('home',
                                    page=pagination.next_num,
                                    drink_name=request.args.get('drink_name',''),
                                    calorie_min=request.args.get('calorie_min',''),
                                    calorie_max=request.args.get('calorie_max',''),
                                    caffeine_min=request.args.get('caffeine_min',''),
                                    caffeine_max=request.args.get('caffeine_max','')) }}">
                Next
            </a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}

    </ul>
</nav>

<script>
    const calorieRange = new Slider("#calorieRange", {
        min: 5, max: 250, value: [80, 150], range: true
    });

    const sugarRange = new Slider("#sugarRange", {
        min: 5, max: 250, value: [80, 150], range: true
    });
</script>

{% endblock %}

